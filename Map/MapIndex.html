<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <title>Pac-Man</title>
    <style>
      body {
        background: #222;
        color: #fff;
        text-align: center;
        font-family: sans-serif;
      }
      canvas {
        background: black;
        margin: 10px auto;
        display: block;
      }
    </style>
  </head>
  <body>
    <h1>Pac-Man</h1>
    <h2 id="scoreDisplay">Score: 0</h2>
    <canvas id="gameCanvas"></canvas>

    <!--  Nhúng dữ liệu map từ file Map.js -->
    <script src="Map.js"></script>

    <!-- Mã chính trò chơi -->
    <script>
      const TILE_SIZE = 20; // kích thước mỗi ô (pixel)
      // Tham chiếu DOM và các biến trạng thái chính của trò chơi
      // --- THÊM: Load ảnh Pac-Man ---
      const pacImages = {
        right: new Image(),
        left: new Image(),
        up: new Image(),
        down: new Image(),
      };
      // Đường dẫn "../assets/" nghĩa là lùi ra một thư mục để vào assets
      pacImages.right.src = "../assets/pacmanRight.png";
      pacImages.left.src = "../assets/pacmanLeft.png";
      pacImages.up.src = "../assets/pacmanUp.png";
      pacImages.down.src = "../assets/pacmanDown.png";

      // ... (code pacImages cũ) ...

      // --- THÊM: Load ảnh Ghosts ---
      const ghostImages = {
        red: new Image(),
        pink: new Image(),
        orange: new Image(),
        blue: new Image(),
        scared: new Image(),
      };
      ghostImages.red.src = "../assets/redGhost.png";
      ghostImages.pink.src = "../assets/pinkGhost.png";
      ghostImages.orange.src = "../assets/orangeGhost.png";
      ghostImages.blue.src = "../assets/blueGhost.png";
      ghostImages.scared.src = "../assets/scaredGhost.png";

      let canvas;
      let ctx;
      let scoreEl;
      let currentMap = [];
      let currentWallColor = "#09f";
      let score = 0;
      let gameOver = false;
      let gameInterval = null;

      // Trạng thái của Pac-Man trên lưới
      let pacMan = {
        x: 0,
        y: 0,
        dx: 0,
        dy: 0,
        nextDx: 0,
        nextDy: 0,
        rotation: "right", // Mặc định quay sang phải để vẽ đúng hình khởi điểm
      };

      function updateScore() {
        scoreEl.textContent = `Score: ${score}`;
      }

      // Luôn sao chép sâu để viên kẹo được khôi phục cho mỗi ván chơi mới
      function cloneMap(mapData) {
        return structuredClone(mapData);
      }

      // Mảng chứa các object Ghost
      let ghosts = [];

      function spawnGhosts(mapData) {
        let spawnedGhosts = [];
        let colors = ["red", "pink", "orange"];
        let houseTiles = []; // Danh sách chứa tất cả ô nhà ma

        // 1. Gom tất cả các ô số 2 vào danh sách
        for (let y = 0; y < mapData.length; y++) {
          for (let x = 0; x < mapData[0].length; x++) {
            if (mapData[y][x] === 2) {
              houseTiles.push({ x: x, y: y });
            }
          }
        }

        if (houseTiles.length === 0) return [];

        // 2. Tìm vị trí giữa danh sách (index)
        let mid = Math.floor(houseTiles.length / 2);

        // 3. Đặt 3 con ma vào các vị trí: Giữa, Trước Giữa, Sau Giữa
        // Cách này đảm bảo chúng luôn nằm cạnh nhau trong lòng nhà ma

        // Con 1 (Đỏ) -> Chính giữa
        if (houseTiles[mid]) {
          spawnedGhosts.push({
            x: houseTiles[mid].x,
            y: houseTiles[mid].y,
            color: colors[0],
            dx: 0,
            dy: 0,
          });
        }

        // Con 2 (Hồng) -> Lùi lại 1 ô
        if (houseTiles[mid - 1]) {
          spawnedGhosts.push({
            x: houseTiles[mid - 1].x,
            y: houseTiles[mid - 1].y,
            color: colors[1],
            dx: 0,
            dy: 0,
          });
        }

        // Con 3 (Cam) -> Tiến lên 1 ô
        if (houseTiles[mid + 1]) {
          spawnedGhosts.push({
            x: houseTiles[mid + 1].x,
            y: houseTiles[mid + 1].y,
            color: colors[2],
            dx: 0,
            dy: 0,
          });
        }

        // Con 4 (Xanh)
        if (houseTiles[mid + 2]) {
          spawnedGhosts.push({
            x: houseTiles[mid + 2].x,
            y: houseTiles[mid + 2].y,
            color: "blue",
            dx: 0,
            dy: 0,
          });
        }

        return spawnedGhosts;
      }

      // Chuẩn bị trạng thái và chọn map tiếp theo trước khi chạy vòng lặp
      function startGame() {
        const totalMaps = MAPS.length;
        function getNextMapIndex() {
          let shown = [];
          try {
            shown = JSON.parse(localStorage.getItem("shownMaps") || "[]");
          } catch (e) {
            console.warn("shownMaps data invalid. Resetting storage.", e);
            shown = [];
            localStorage.removeItem("shownMaps");
          }
          if (shown.length >= totalMaps) {
            shown = [];
          }
          const available = [];
          for (let i = 0; i < totalMaps; i++) {
            if (!shown.includes(i)) available.push(i);
          }
          const idx = available[Math.floor(Math.random() * available.length)];
          shown.push(idx);
          localStorage.setItem("shownMaps", JSON.stringify(shown));
          return idx;
        }

        if (gameInterval) {
          clearInterval(gameInterval);
        }

        const nextMapIdx = getNextMapIndex();
        const selectedMap = MAPS[nextMapIdx];
        currentMap = cloneMap(selectedMap.map);
        currentWallColor = selectedMap.wall_color || "#09f";
        score = 0;
        gameOver = false;
        canvas.width = currentMap[0].length * TILE_SIZE;
        canvas.height = currentMap.length * TILE_SIZE;
        updateScore();

        // Tìm vị trí spawn đầu tiên (ô giá trị 0) cho Pac-Man
        // const spawn = findSpawnPoint(currentMap);
        // pacMan.x = spawn.x;
        // pacMan.y = spawn.y;
        // pacMan.dx = 0;
        // pacMan.dy = 0;
        // pacMan.nextDx = 0;
        // pacMan.nextDy = 0;

        // THAY THẾ BẰNG HÀM SPAWN NGẪU NHIÊN
        const spawn = findRandomSpawnPoint(currentMap);
        pacMan.x = spawn.x;
        pacMan.y = spawn.y;
        pacMan.dx = 0;
        pacMan.dy = 0;
        pacMan.nextDx = 0;
        pacMan.nextDy = 0;

        currentMap[pacMan.y][pacMan.x] = 3; // Đánh dấu ô xuất phát là đã ăn (đường trống)

        gameInterval = setInterval(gameLoop, 200);

        // --- THÊM: Tạo ma ---
        ghosts = spawnGhosts(currentMap);

        gameInterval = setInterval(gameLoop, 200);
      }

      // Tìm ô giá trị 0 đầu tiên trong map để làm điểm xuất phát
      // function findSpawnPoint(mapData) {
      //   for (let y = 0; y < mapData.length; y++) {
      //     for (let x = 0; x < mapData[y].length; x++) {
      //       if (mapData[y][x] === 0) {
      //         return { x, y };
      //       }
      //     }
      //   }
      //   // Fallback nếu không tìm thấy ô hợp lệ
      //   return { x: 0, y: 0 };
      // }

      // THAY THẾ FIND SPAWN POINT BẰNG HÀM SPAWN NGẪU NHIÊN
      function findRandomSpawnPoint(mapData) {
        let validSpots = [];
        for (let y = 0; y < mapData.length; y++) {
          for (let x = 0; x < mapData[0].length; x++) {
            // Chỉ lấy đường đi (0), bỏ qua tường (1) và nhà ma (2)
            if (mapData[y][x] === 0) {
              validSpots.push({ x: x, y: y });
            }
          }
        }

        if (validSpots.length === 0) return { x: 1, y: 1 }; // Fallback

        // Chọn ngẫu nhiên một tọa độ trong danh sách
        const randomIndex = Math.floor(Math.random() * validSpots.length);
        return validSpots[randomIndex];
      }

      // Vòng lặp chính luân phiên update/draw theo nhịp lưới cố định
      function gameLoop() {
        if (gameOver) return;
        update();
        draw();
      }

      function update() {
        //TODO: Thêm Logic đường hầm cho Pac-man ( Chưa triển khai )
        // Nơi xử lý logic di chuyển, tính điểm... (hiện tại chưa triển khai)
        let checkTurnX = pacMan.x + pacMan.nextDx;
        let checkTurnY = pacMan.y + pacMan.nextDy;

        // Nếu ô dự kiến KHÔNG phải tường (1), thì cập nhật hướng đi thật
        if (currentMap[checkTurnY][checkTurnX] !== 1) {
          pacMan.dx = pacMan.nextDx;
          pacMan.dy = pacMan.nextDy;
        }

        // 2. DI CHUYỂN: Tính vị trí tiếp theo dựa trên hướng thật
        let nextX = pacMan.x + pacMan.dx;
        let nextY = pacMan.y + pacMan.dy;

        // 3. VA CHẠM: Nếu ô tiếp theo KHÔNG phải tường (1), thì cho đi
        if (currentMap[nextY][nextX] !== 1) {
          pacMan.x = nextX;
          pacMan.y = nextY;
        }

        // 4. ĂN ĐIỂM: Nếu vị trí hiện tại là kẹo (0)
        if (currentMap[pacMan.y][pacMan.x] === 0) {
          currentMap[pacMan.y][pacMan.x] = 3; // Đổi thành đường trống
          score += 10;
          updateScore();
        }

        // Xác định hướng quay của Pac
        if (pacMan.dx === 1) pacMan.rotation = "right";
        else if (pacMan.dx === -1) pacMan.rotation = "left";
        else if (pacMan.dy === -1) pacMan.rotation = "up";
        else if (pacMan.dy === 1) pacMan.rotation = "down";
      }

      function draw() {
        const rows = currentMap.length;
        const cols = rows ? currentMap[0].length : 0;

        // 1. Xóa màn hình để vẽ khung hình mới
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 2. Vẽ Bản Đồ (Tường, Kẹo, Nhà Ma)
        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < cols; x++) {
            const cell = currentMap[y][x];

            // Vẽ nền đen cho đường đi trước
            if (cell !== 1) {
              ctx.fillStyle = "black";
              ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            }

            if (cell === 1) {
              // Vẽ Tường (Dùng màu quy định trong Map.js)
              ctx.fillStyle = currentWallColor;
              ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else if (cell === 2) {
              // Vẽ Nhà Ma (Màu xám tối)
              ctx.fillStyle = "#444";
              ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            } else if (cell === 0) {
              // Vẽ Viên Kẹo (Chấm trắng nhỏ)
              ctx.fillStyle = "white";
              ctx.beginPath();
              ctx.arc(
                x * TILE_SIZE + TILE_SIZE / 2,
                y * TILE_SIZE + TILE_SIZE / 2,
                2, // Kích thước viên kẹo
                0,
                Math.PI * 2
              );
              ctx.fill();
            }
            // cell === 3 là đường trống (đã ăn), đã vẽ nền đen ở trên nên không cần làm gì thêm
          }

          // --- THÊM: Vẽ Ghosts ---
          for (let ghost of ghosts) {
            let img = ghostImages[ghost.color] || ghostImages.red;
            ctx.drawImage(
              img,
              ghost.x * TILE_SIZE,
              ghost.y * TILE_SIZE,
              TILE_SIZE,
              TILE_SIZE
            );
          }
        }

        // 3. Vẽ Pac-Man (Dùng Ảnh)
        // Lấy ảnh tương ứng với hướng quay (right, left, up, down)
        // Nếu chưa có hướng (lúc mới start), mặc định dùng ảnh 'right'
        let img = pacImages[pacMan.rotation] || pacImages.right;

        // Vẽ ảnh lên Canvas
        ctx.drawImage(
          img,
          pacMan.x * TILE_SIZE, // Tọa độ pixel X
          pacMan.y * TILE_SIZE, // Tọa độ pixel Y
          TILE_SIZE, // Chiều rộng (bằng kích thước ô)
          TILE_SIZE // Chiều cao
        );
      }

      // Xử lý sự kiện bàn phím
      document.addEventListener("keydown", (e) => {
        if (gameOver) return;

        // Lưu ý: Chúng ta chỉ thay đổi hướng DỰ KIẾN (nextDx, nextDy)
        // chứ không đổi hướng thật ngay lập tức.
        switch (e.key) {
          case "ArrowLeft":
            pacMan.nextDx = -1;
            pacMan.nextDy = 0;
            break;
          case "ArrowRight":
            pacMan.nextDx = 1;
            pacMan.nextDy = 0;
            break;
          case "ArrowUp":
            pacMan.nextDx = 0;
            pacMan.nextDy = -1;
            break;
          case "ArrowDown":
            pacMan.nextDx = 0;
            pacMan.nextDy = 1;
            break;
        }
      });

      document.addEventListener("DOMContentLoaded", () => {
        // Chỉ bắt đầu game sau khi DOM đã sẵn sàng
        canvas = document.getElementById("gameCanvas");
        ctx = canvas.getContext("2d");
        scoreEl = document.getElementById("scoreDisplay");
        startGame();
      });
    </script>
  </body>
</html>
